pipeline {
    agent none
    stages {
        stage('Get Code') {
            agent { label 'built-in' }
            steps {
                echo "=== AGENT INFO ==="
                bat 'whoami'
                bat 'hostname'
                bat 'echo WORKSPACE: %WORKSPACE%'
                echo "=================="
                
                git 'https://github.com/viktorcito/unir-cp1-devops.git'
                stash name: 'codigo', includes: '**/*'
            }
        }
        
        stage('Unit Tests') {
            agent { label 'agent1' }
            steps {
                echo "=== AGENT INFO ==="
                bat 'whoami'
                bat 'hostname'
                bat 'echo WORKSPACE: %WORKSPACE%'
                echo "=================="
                
                unstash 'codigo'
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        set PYTHONPATH=%WORKSPACE%
                        "C:\\Program Files\\Python314\\python.exe" -m pytest test\\unit --junitxml=result-unit.xml
                    '''
                }
                stash name: 'unit-results', includes: 'result-unit.xml'
            }
        }
        
        stage('Rest Tests') {
            agent { label 'agent1' }
            steps {
                echo "=== AGENT INFO ==="
                bat 'whoami'
                bat 'hostname'
                bat 'echo WORKSPACE: %WORKSPACE%'
                echo "=================="
                
                unstash 'codigo'
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat '''
                        set FLASK_APP=app\\api.py
                        set FLASK_ENV=development
                        start "" /B cmd /c "C:\\Program Files\\Python314\\python.exe" -m flask run
                        start "" /B java -jar C:\\wiremock\\wiremock-standalone.jar --port 9090 --root-dir C:\\wiremock
                        ping 127.0.0.1 -n 6 > nul
                        set PYTHONPATH=%WORKSPACE%
                        "C:\\Program Files\\Python314\\python.exe" -m pytest test\\rest --junitxml=result-rest.xml
                    '''
                }
                stash name: 'rest-results', includes: 'result-rest.xml'
            }
        }
        
        stage('Parallel Tests') {
            parallel {
                stage('Static Analysis') {
                    agent { label 'agent1' }
                    steps {
                        echo "=== AGENT INFO ==="
                        bat 'whoami'
                        bat 'hostname'
                        bat 'echo WORKSPACE: %WORKSPACE%'
                        echo "=================="
                        
                        unstash 'codigo'
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            bat '"C:\\Program Files\\Python314\\python.exe" -m flake8 app --exit-zero'
                        }
                    }
                }
                
                stage('Security Analysis') {
                    agent { label 'agent2' }
                    steps {
                        echo "=== AGENT INFO ==="
                        bat 'whoami'
                        bat 'hostname'
                        bat 'echo WORKSPACE: %WORKSPACE%'
                        echo "=================="
                        
                        unstash 'codigo'
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            bat '"C:\\Program Files\\Python314\\python.exe" -m bandit -r app --exit-zero'
                        }
                    }
                }
                
                stage('Coverage') {
                    agent { label 'agent1' }
                    steps {
                        echo "=== AGENT INFO ==="
                        bat 'whoami'
                        bat 'hostname'
                        bat 'echo WORKSPACE: %WORKSPACE%'
                        echo "=================="
                        
                        unstash 'codigo'
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            bat '''
                                set PYTHONPATH=%WORKSPACE%
                                "C:\\Program Files\\Python314\\python.exe" -m coverage run --branch --source=app -m pytest test\\unit
                                "C:\\Program Files\\Python314\\python.exe" -m coverage report
                                "C:\\Program Files\\Python314\\python.exe" -m coverage xml -o coverage.xml
                            '''
                        }
                    }
                }
                
                stage('Performance') {
                    agent { label 'agent2' }
                    steps {
                        echo "=== AGENT INFO ==="
                        bat 'whoami'
                        bat 'hostname'
                        bat 'echo WORKSPACE: %WORKSPACE%'
                        echo "=================="
                        
                        unstash 'codigo'
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            bat '''
                                set FLASK_APP=app\\api.py
                                start "" /B cmd /c "C:\\Program Files\\Python314\\python.exe" -m flask run
                                ping 127.0.0.1 -n 4 > nul
                                C:\\jmeter\\apache-jmeter-5.6.3\\bin\\jmeter -n -t test\\jmeter\\flask.jmx -l result-performance.jtl
                            '''
                            perfReport sourceDataFiles: 'result-performance.jtl'
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            node('built-in') {
                unstash 'unit-results'
                unstash 'rest-results'
                junit 'result-*.xml'
            }
        }
    }
}
